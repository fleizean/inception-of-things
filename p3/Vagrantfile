Vagrant.configure("2") do |config|
  config.vm.box      = "debian/bullseye64"
  config.vm.hostname = "eozmertS"

  # Paylaşımlı klasör (vbguest yoksa rsync daha az sorun çıkarır)
  # config.vm.synced_folder ".", "/vagrant", type: "rsync", rsync__auto: "true"
  config.vm.synced_folder ".", "/vagrant", type: "virtualbox"

  # İsteğe bağlı host-only IP
  config.vm.network "private_network", ip: "192.168.56.110"

  # ArgoCD UI ve app için portlar
  config.vm.network "forwarded_port", guest: 30080, host: 30080
  config.vm.network "forwarded_port", guest: 8888,  host: 8888

  config.vm.provider "virtualbox" do |v|
    v.name   = "eozmertS"
    v.memory = 4096
    v.cpus   = 2
  end

  # Küçük DNS/CRLF hazırlığı (isteğe bağlı)
  config.vm.provision "shell", inline: <<-'SHELL'
    set -Eeuo pipefail
    sudo apt-get update -y
    sudo apt-get install -y dos2unix
    sudo dos2unix /vagrant/scripts/*.sh || true
    sudo chmod +x /vagrant/scripts/*.sh || true
  SHELL

  # 1) Kurulum
  config.vm.provision "shell",
    path: "scripts/install.sh",
    env: { "USE_INGRESS" => "true", "CONFS_DIR" => "/vagrant/confs" }

  # 2) Cluster + ArgoCD + Ingress
  config.vm.provision "shell",
    path: "scripts/setup.sh",
    env: { "USE_INGRESS" => "true", "CONFS_DIR" => "/vagrant/confs" }

  # 3) Uygulama (application.yaml vs.)
  config.vm.provision "shell",
    path: "scripts/deploy.sh",
    env: { "CONFS_DIR" => "/vagrant/confs" }
end
